---
id: 576
title: 'Java调用外部进程并拦截输出流的实例: 进程管理器1.0版(原创)'
date: 2010-08-16T20:04:00+00:00
author: 刘长炯
layout: post
guid: http://www.beansoft.biz/?p=576
permalink: '/2010/08/16/java%e8%b0%83%e7%94%a8%e5%a4%96%e9%83%a8%e8%bf%9b%e7%a8%8b%e5%b9%b6%e6%8b%a6%e6%88%aa%e8%be%93%e5%87%ba%e6%b5%81%e7%9a%84%e5%ae%9e%e4%be%8b-%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86%e5%99%a81-0%e7%89%88/'
views:
  - "3778"
original_post_id:
  - "576"
image: /wp-content/uploads/2012/09/image141.png
categories:
  - Java SE
---
</p> 

<span class="wenzhang_con" id="articlecontent" style="width:740px;">2007.01.06 旧文整理 作者: BeanSoft</span>

<span class="wenzhang_con" style="width:740px;">这个东西是我当时写了用来调试偶们的短信平台的, 因为当时还不知道 Eclipse, 所以为了反复测试短信应用, 不得不同时启动四个Java进程才能工作: app.bat &#8211; 应用服务器, sim.bat &#8211; 手机模拟器,sonsole.bat &#8211; 控制台,um.bat &#8211; 用户管理器. 原来的时候呢, 要反复切换四个 DOS 窗口来查看开发的应用产生的日志, 而且错误信息也不方便浏览. 后来通过使用 Java 中的进程输出流成功的解决了这个疑难问题, 并制作了一个 Java 进程启动控制中心, 能够运行, 终止, 启动这些进程, 对进程的输出进行加颜色区别显示, 使用配置文件来方便的修改/添加新的进程启动参数, 但是没有实现拦截输入流的功能. 如下图所示:&#160; </p> 

<p>
  <img title="image" style="border-right:0;border-top:0;display:inline;border-left:0;border-bottom:0;" height="449" alt="image" src="http://www.beansoft.biz/wp-content/uploads/2010/08/image14.png" width="538" border="0" />&#160;&#160;
</p>

<p>
  下载(含源码): </span>
</p>

<table class="Listing" id="Listing" cellspacing="0" cellpadding="0" border="0">
  <tr>
    <td>
      <a href="http://www.blogjava.net/Files/beansoft/ProcessViewer.zip"><font color="#002c99">ProcessViewer.zip</font></a>
    </td>
    
    <td>
      204KB
    </td>
  </tr>
</table>

<p>
  讲解: 首先关于拦截流的基础知识可以参考 BlogJava 的两篇文章: <a href="http://www.blogjava.net/lewhwa/archive/2007/01/14/93818.html">Java调用外部进程并拦截输入输出流－－Java IDE Console解密（上篇）</a>&#160;<a href="http://www.blogjava.net/lewhwa/archive/2007/01/15/94060.html">Java调用外部进程并拦截输入输出流－－Java IDE Console解密（下篇）</a>, 倒省了我费口舌来说那么多了, 呵呵.
</p>

<p>
  首先上例中的进程代码为: java -cp ./classes TestWithOutput
</p>

<p>
  再看TestWithOutput.java:
</p>

<div style="border-right:rgb(204,204,204) 1px solid;border-top:rgb(204,204,204) 1px solid;font-size:13px;border-left:rgb(204,204,204) 1px solid;width:98%;border-bottom:rgb(204,204,204) 1px solid;background-color:rgb(238,238,238);padding:4px 5px 4px 4px;">
  <span style="color:rgb(0,0,0);"> </p> 
  
  <p>
    </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />* <p>Title: TestWithOutput</p> <br />* <p>Description: Java 进程查看器辅助工具, 命令行输出内容进行测试</p> <br />* <p>Copyright: Copyright (c) 2003</p> <br />* <p>Company: BeanSoft Studio</p> <br />* </span><span style="color:rgb(128,128,128);">@author</span><span style="color:rgb(0,128,0);"> 刘长炯 <br />* </span><span style="color:rgb(128,128,128);">@version</span><span style="color:rgb(0,128,0);"> 1.0 <br />&#160;</span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> </p> 
    
    <p>
      </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">class</span><span style="color:rgb(0,0,0);"> TestWithOutput { </p> 
      
      <p>
        &#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> TestWithOutput() </span><span style="color:rgb(0,0,255);">throws</span><span style="color:rgb(0,0,0);"> Exception { <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> Dead lock, for test purpose only</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">for</span><span style="color:rgb(0,0,0);">(</span><span style="color:rgb(0,0,255);">int</span><span style="color:rgb(0,0,0);"> i </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);"></span><span style="color:rgb(0,0,0);">;; i</span><span style="color:rgb(0,0,0);">++</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160; Thread.currentThread().sleep(</span><span style="color:rgb(0,0,0);">500L</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160; System.out.println(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">输出:</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> i); <br />&#160;&#160;&#160;&#160;&#160; System.err.println(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">错误:</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> i); <br />&#160;&#160;&#160; } <br />&#160; } </p> 
        
        <p>
          &#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">static</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> main(String[] args) </span><span style="color:rgb(0,0,255);">throws</span><span style="color:rgb(0,0,0);"> Exception { <br />&#160;&#160;&#160; TestWithOutput testWithOutput1 </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> TestWithOutput(); <br />&#160; } </p> 
          
          <p>
            }</span></div> 
            
            <p>
              可以看到我们成功的拦截了输出和错误流的内容并用不同的颜色加以区分.
            </p>
            
            <p>
              我们的内核我依稀记得是搬移自 BeanShell 的 JConsole(很老的版本的了), 它的类名叫 JConsole, 实现了输出到彩色字符串的功能. 接下来的核心就是对 Process 的处理了:
            </p>
            
            <div style="border-right:rgb(204,204,204) 1px solid;border-top:rgb(204,204,204) 1px solid;font-size:13px;border-left:rgb(204,204,204) 1px solid;width:98%;border-bottom:rgb(204,204,204) 1px solid;background-color:rgb(238,238,238);padding:4px 5px 4px 4px;">
              <span style="color:rgb(0,0,255);">package</span><span style="color:rgb(0,0,0);"> studio.beansoft.system; </p> 
              
              <p>
                </span><span style="color:rgb(0,0,255);">import</span><span style="color:rgb(0,0,0);"> java.io.</span><span style="color:rgb(0,0,0);">*</span><span style="color:rgb(0,0,0);">; </p> 
                
                <p>
                  </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);">&#160; <p>Title: Process Viewer &#8211; ProcessHandler</p> <br />*&#160; <p>Description: Java 进程查看器 &#8211; 进程处理器, 封装了对进程的处理工作</p> <br />*&#160; <p>Copyright: Copyright (c) 2003</p> <br />*&#160; <p>Company: BeanSoft Studio</p> <br />&#160;</span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br /></span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">class</span><span style="color:rgb(0,0,0);"> ProcessHandler{ <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 命令字符串 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);"> String commandString </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</s><span style="color:rgb(0,0,0);">""</span><span style="color:rgb(0,0,0);">; <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 进程标题 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);"> String processTitle </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">""</span><span style="color:rgb(0,0,0);">; <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 当前引用的进程 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);"> Process process; <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 输出缓冲区 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 用来显示输出的 javax.swing.JTextArea </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> Show whether the process still active </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">boolean</span><span style="color:rgb(0,0,0);"> isInProcess </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">false</span><span style="color:rgb(0,0,0);">; <br />&#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 图形化的输出控制台 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);"> JConsole jConsole; </p> 
                  
                  <p>
                    &#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> ProcessHandler() { <br />&#160; } </p> 
                    
                    <p>
                      &#160; </span><span style="color:rgb(0,128,0);">/*</span><span style="color:rgb(0,128,0);"> For test purpose only. </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">static</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> main(String[] args) { <br />&#160;&#160;&#160; ProcessHandler processHandler1 </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> ProcessHandler(); <br />&#160;&#160;&#160; processHandler1.setCommandString(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">java TestWithOutput</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);">processHandler1.setBufferSize(100);</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160; javax.swing.JFrame frame </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> javax.swing.JFrame(); <br />&#160;&#160;&#160; studio.beansoft.system.JConsole console </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> studio.beansoft.system.JConsole(); <br />&#160;&#160;&#160; frame.getContentPane().add(console); <br />&#160;&#160;&#160; frame.setSize(</span><span style="color:rgb(0,0,0);">600</span><span style="color:rgb(0,0,0);">, </span><span style="color:rgb(0,0,0);">400</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160; frame.show(); <br />&#160;&#160;&#160; processHandler1.setJConsole(console); <br />&#160;&#160;&#160; processHandler1.startProcess(); <br />&#160; } </p> 
                      
                      <p>
                        &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 根据给定命令启动进程并创建读取参数的线程. <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> startProcess() { <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> 该进程已经运行了, 不能重复运行.</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">if</span><span style="color:rgb(0,0,0);"> (process </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) </span><span style="color:rgb(0,0,255);">return</span><span style="color:rgb(0,0,0);">; </p> 
                        
                        <p>
                          &#160;&#160;&#160; isInProcess </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">true</span><span style="color:rgb(0,0,0);">; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> Set the process active flag be valid</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160; Thread processThread </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> Thread() { <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> run() { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">try</span><span style="color:rgb(0,0,0);"> { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">正在启动进程, 命令:</span><span style="color:rgb(0,0,0);">""</span><span style="color:rgb(0,0,0);"> + getCommandString() + </span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);"></span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">, 名称:</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> getProcessTitle() </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); </p> 
                          
                          <p>
                            &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);">final ByteArrayOutputStream out = new ByteArrayOutputStream();</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; process </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> Runtime.getRuntime().exec(getCommandString()); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">final</span><span style="color:rgb(0,0,0);"> BufferedReader pin </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> BufferedReader( <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> InputStreamReader(process.getInputStream())); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OutputStream processOut </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> process.getOutputStream(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">final</span><span style="color:rgb(0,0,0);"> BufferedReader perr </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> BufferedReader( <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> InputStreamReader(process.getErrorStream())); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">int</span><span style="color:rgb(0,0,0);"> data; </p> 
                            
                            <p>
                              &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> Because pin and perr are streams connect to the same process, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> so when you read out one staream, the another stream is also closed, <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> we only can start both reading in a thread</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Thread errReadThread </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">new</span><span style="color:rgb(0,0,0);"> Thread() { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> run() { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">try</span><span style="color:rgb(0,0,0);"> { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; String line; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">while</span><span style="color:rgb(0,0,0);"> ( (line </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> perr.readLine()) </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printError(line </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">catch</span><span style="color:rgb(0,0,0);"> (Exception ex) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ex.printStackTrace(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }; </p> 
                              
                              <p>
                                &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; errReadThread.start();
                              </p>
                              
                              <p>
                                &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> 进程输出流的读取</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; String line </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">while</span><span style="color:rgb(0,0,0);"> ( (line </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> pin.readLine()) </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printOutput(line </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> 
                                
                                <p>
                                  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; isInProcess </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">false</span><span style="color:rgb(0,0,0);">; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);"> End the display thread</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);"> <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">int</span><span style="color:rgb(0,0,0);"> exitValue </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> process.exitValue(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">if</span><span style="color:rgb(0,0,0);"> (exitValue </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);"></span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">while</span><span style="color:rgb(0,0,0);"> ( (line </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> perr.readLine()) </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printError(line </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&<br /> #160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n进程退出时发生了错误, 错误码为:</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> exitValue </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">else</span><span style="color:rgb(0,0,0);"> { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">进程已经正常退出.n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p> 
                                  
                                  <p>
                                    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; process.waitFor(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; process.destroy(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; process </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);">System.out.println(process);</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160;&#160;&#160;&#160;&#160; } </span><span style="color:rgb(0,0,255);">catch</span><span style="color:rgb(0,0,0);"> (Exception ex) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">运行命令时发生错误:</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> ex </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stopProcess(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160; }; <br />&#160;&#160;&#160; processThread.start(); <br />&#160; } </p> 
                                    
                                    <p>
                                      &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 结束当前正在执行的进程. <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> stopProcess() { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">if</span><span style="color:rgb(0,0,0);"> (process </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">try</span><span style="color:rgb(0,0,0);"> { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">正在尝试终止进程 </span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);"> getProcessTitle() </span><span style="color:rgb(0,0,0);">+</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);"><img src="http://image.360doc.com/DownloadImg/13829/385370_2.gif" />n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; process.destroy(); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; printNote(</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">进程已经被终止了.n</span><span style="color:rgb(0,0,0);">"</span><span style="color:rgb(0,0,0);">); <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; process </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">; <br />&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">catch</span><span style="color:rgb(0,0,0);"> (Exception e) { <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.printStackTrace(); <br />&#160;&#160;&#160;&#160;&#160; } <br />&#160;&#160;&#160; } <br />&#160; } </p> 
                                      
                                      <p>
                                        &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 以红色输出错误信息 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> printError(String message) { <br />&#160;&#160;&#160; getJConsole().print(message, java.awt.Color.red); <br />&#160; } </p> 
                                        
                                        <p>
                                          &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 以橙色输出注释信息 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> printNote(String note) { <br />&#160;&#160;&#160; getJConsole().print(note, java.awt.Color.orange); <br />&#160; } </p> 
                                          
                                          <p>
                                            &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> 向控制台转发输出 </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">private</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> printOutput(String output) { <br />&#160;&#160;&#160; getJConsole().print(output, java.awt.Color.blue); <br />&#160; } </p> 
                                            
                                            <p>
                                              &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 重新开始进程(先尝试停止, 然后再开始) <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> restartProcess() { <br />&#160;&#160;&#160; stopProcess(); <br />&#160;&#160;&#160; startProcess(); <br />&#160; } </p> 
                                              
                                              <p>
                                                &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 返回进程要执行的命令的字符串. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@return</span><span style="color:rgb(0,128,0);"> commandString 属性 <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><br /> <span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> String getCommandString() { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">return</span><span style="color:rgb(0,0,0);"> commandString; <br />&#160; } </p> 
                                                
                                                <p>
                                                  &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 设置 commandString 属性. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@param</span><span style="color:rgb(0,128,0);"> commandString 要执行的命令的字符串 <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> setCommandString(String commandString) { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">this</span><span style="color:rgb(0,0,0);">.commandString </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> commandString; <br />&#160; } </p> 
                                                  
                                                  <p>
                                                    &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 返回进程的标题. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@return</span><span style="color:rgb(0,128,0);"> processTitle 属性 <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> String getProcessTitle() { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">return</span><span style="color:rgb(0,0,0);"> processTitle; <br />&#160; } </p> 
                                                    
                                                    <p>
                                                      &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 设置进程的标题. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@param</span><span style="color:rgb(0,128,0);"> processTitle 进程标题字符串 <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> setProcessTitle(String processTitle) { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">this</span><span style="color:rgb(0,0,0);">.processTitle </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> processTitle; <br />&#160; } </p> 
                                                      
                                                      <p>
                                                        &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 返回当前输出显示的文本区的实例. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@return</span><span style="color:rgb(0,128,0);"> 当前输出显示的文本区对象. <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> JConsole getJConsole() { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">return</span><span style="color:rgb(0,0,0);"> jConsole; <br />&#160; } </p> 
                                                        
                                                        <p>
                                                          &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 设置输出显示的 JTextArea. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@param</span><span style="color:rgb(0,128,0);"> jConsole 指定的 JTextArea <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> setJConsole(JConsole jConsole) { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">this</span><span style="color:rgb(0,0,0);">.jConsole </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> jConsole; <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">if</span><span style="color:rgb(0,0,0);">(jConsole </span><span style="color:rgb(0,0,0);">!=</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">null</span><span style="color:rgb(0,0,0);">) { <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);">System.setErr(getJConsole().getErr()); <br />&#160;&#160;&#160;&#160;&#160; </span><span style="color:rgb(0,128,0);">//</span><span style="color:rgb(0,128,0);">System.setOut(getJConsole().getOut());</span><span style="color:rgb(0,128,0);"> <br /></span><span style="color:rgb(0,0,0);">&#160;&#160;&#160; } <br />&#160; } </p> 
                                                          
                                                          <p>
                                                            &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 返回管理的进程的实例. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@return</span><span style="color:rgb(0,128,0);"> 当前进程的实例. <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);"> Process getProcess() { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">return</span><span style="color:rgb(0,0,0);"> process; <br />&#160; } </p> 
                                                            
                                                            <p>
                                                              &#160; </span><span style="color:rgb(0,128,0);">/**</span><span style="color:rgb(0,128,0);"> <br />&#160;&#160; * 设置当前管理的进程示例. <br />&#160;&#160; * </span><span style="color:rgb(128,128,128);">@param</span><span style="color:rgb(0,128,0);"> process 被管理的进程示例. <br />&#160;&#160; </span><span style="color:rgb(0,128,0);">*/</span><span style="color:rgb(0,0,0);"> <br />&#160; </span><span style="color:rgb(0,0,255);">public</span><span style="color:rgb(0,0,0);">&#160;</span><span style="color:rgb(0,0,255);">void</span><span style="color:rgb(0,0,0);"> setProcess(Process process) { <br />&#160;&#160;&#160; </span><span style="color:rgb(0,0,255);">this</span><span style="color:rgb(0,0,0);">.process </span><span style="color:rgb(0,0,0);">=</span><span style="color:rgb(0,0,0);"> process; <br />&#160; } </p> 
                                                              
                                                              <p>
                                                                }</span></div> 
                                                                
                                                                <p>
                                                                  在 startProcess() 的时候对输出进行拦截, 并根据信息的类型输出消息. 进程结束的时候就输出进程已经完成的信息.
                                                                </p>
                                                                
                                                                <p>
                                                                  OK, enjoy it!
                                                                </p>
                                                                
                                                                <p>
                                                                  转载请注明：<a href="http://www.beansoft.biz">WebLogic Android 博客</a> &raquo; <a href="http://www.beansoft.biz/2010/08/16/java%e8%b0%83%e7%94%a8%e5%a4%96%e9%83%a8%e8%bf%9b%e7%a8%8b%e5%b9%b6%e6%8b%a6%e6%88%aa%e8%be%93%e5%87%ba%e6%b5%81%e7%9a%84%e5%ae%9e%e4%be%8b-%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86%e5%99%a81-0%e7%89%88/">Java调用外部进程并拦截输出流的实例: 进程管理器1.0版(原创)</a>
                                                                </p>